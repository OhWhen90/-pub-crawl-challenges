<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Pub Crawl Challenge List</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 18px;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      background: #f9f9f9;
      color: #222;
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: flex;
      align-items: flex-start;
      padding: 0.6rem 0;
      font-size: 1.2rem;
      cursor: pointer;
    }
    input[type="checkbox"] {
      margin-right: 1rem;
      transform: scale(1.3);
    }
    .emoji {
      margin-right: 0.3rem;
      font-size: 1.4rem;
    }
    .challenge-title {
      font-weight: bold;
    }
    .challenge-desc {
      margin-left: 2.7rem;
      font-size: 1rem;
      color: #555;
      margin-top: -0.3rem;
    }
    .bonus, .rainbow {
      margin-left: 2.7rem;
      font-size: 0.95rem;
      color: #444;
    }
    .rainbow input[type="checkbox"],
    .bonus input[type="checkbox"] {
      transform: scale(1.1);
      margin-right: 0.4rem;
    }
    .rainbow label {
      display: inline-block;
      width: 48%;
      margin-top: 0.3rem;
    }
    #playerName {
      display: block;
      margin: 1rem auto;
      padding: 0.5rem;
      font-size: 1.1rem;
      width: 90%;
      max-width: 300px;
    }
    #nameWarning {
      text-align: center;
      color: red;
      font-size: 1rem;
      margin-top: 0.5rem;
      display: none;
    }
    #startButton {
      display: block;
      margin: 1rem auto;
      padding: 1rem 2rem;
      font-size: 1.4rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    #startButton:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #challenge-container {
      margin-top: 1rem;
    }
    #score-container {
      text-align: center;
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    #leaderboard {
      background: #fff;
      padding: 1rem;
      margin-top: 2rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #leaderboard-list {
      list-style: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    #leaderboard-list li {
      padding: 0.3rem 0;
      border-bottom: 1px solid #eee;
    }
    #refreshLeaderboard {
      display: block;
      margin: 0.5rem auto 1rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>

<h1>Pub Crawl Challenge List</h1>

<input type="text" id="playerName" placeholder="Enter your name" required />
<p id="nameWarning">‚ö†Ô∏è Please enter your name to begin the challenge!</p>

<button id="startButton" disabled>Start Challenges</button>

<div id="challenge-container" style="display:none;"></div>

<div id="score-container" style="display:none;">
  <div id="main-count">‚úîÔ∏è Challenges Completed: 0 / 10</div>
  <div id="bonus-count">‚≠ê Bonus Points Earned: 0 / 10</div>
  <div id="total-score">üèÜ Total Score: 0 / 20</div>
</div>

<div id="leaderboard" style="display:none;">
  <h2>üèÖ Leaderboard</h2>
  <button id="refreshLeaderboard">Refresh Leaderboard</button>
  <ul id="leaderboard-list"></ul>
</div>

<script>
  const endpoint = "https://script.google.com/macros/s/AKfycbyYZVVf7zp_TLu128qJxGRav42bW0hmutv92SXhgk_UKtrj520z9qLfIjApkRMDKxWU/exec";

  const challenges = [
    { id: 0, emojis: ["üîÅ", "üëï"], title: "Closet Shuffle.", desc: "Swap an item of clothing with someone for the entire time at one location." },
    { id: 1, emojis: ["üåà", "üçπ"], title: "Taste the Rainbow.", desc: "Drink two different colours of the rainbow ‚Äî use cocktails, shots, or even mixers.", rainbow: true },
    { id: 2, emojis: ["ü•§", "üç∏"], title: "The Diana Special.", desc: "Finish your entire drink using three (or more) straws at once." },
    { id: 3, emojis: ["üîô", "üö∂‚Äç‚ôÇÔ∏è"], title: "Backwards Journey.", desc: "Walk backwards between any two crawl stops. Safety first, though ‚Äî have a guide!" },
    { id: 4, emojis: ["üß¶", "‚úã"], title: "Sock Puppet Hour.", desc: "Wear a sock on your right hand for the entire time at one location. Introduce it as your new drinking buddy." },
    { id: 5, emojis: ["üï∫", "üíÉ"], title: "Dance-Off Destiny.", desc: "Join or start a dance-off.", bonus: "If you win or get strangers to cheer." },
    { id: 6, emojis: ["ü§´", "üìé"], title: "The Sneaky Peg.", desc: "Clip your peg on someone without them noticing ‚Äî it must stay there for 15 minutes. Proof required!", bonus: "Someone leaves a crawl stop wearing your peg.", bonusAlwaysEnabled: true },
    { id: 7, emojis: ["üé≠", "üó£Ô∏è"], title: "Accent Order (Encore).", desc: "Order your drink in a full accent (e.g. French, pirate, cowboy, Scottish).", bonus: "Stay in character until you have finished your drink." },
    { id: 8, emojis: ["üì∏", "ü§≥"], title: "The Hospitality Selfie.", desc: "Take a selfie with either a bartender or a bouncer.", bonus: "If they smile." },
    { id: 9, emojis: ["üçª", "ü•Ç"], title: "The Icebreaker Toast.", desc: "Walk up to a complete stranger (or another group) and confidently give a short but passionate toast in their honour.", bonus: "They toast back." }
  ];

  const rainbowColors = ["Red", "Orange", "Yellow", "Green", "Blue", "Indigo", "Violet"];
  const rainbowEmojis = {
    Red: "üî¥",
    Orange: "üü†",
    Yellow: "üü°",
    Green: "üü¢",
    Blue: "üîµ",
    Indigo: "üü£",
    Violet: "üü£"
  };

  let playerName = "";

  function createChallenges() {
    const container = document.getElementById("challenge-container");
    container.innerHTML = "";

    challenges.forEach(ch => {
      const label = document.createElement("label");
      label.htmlFor = `chk${ch.id}`;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = `chk${ch.id}`;
      checkbox.disabled = true; // Initially disabled until start
      label.appendChild(checkbox);

      ch.emojis.forEach(e => {
        const span = document.createElement("span");
        span.className = "emoji";
        span.textContent = e;
        label.appendChild(span);
      });

      const titleDiv = document.createElement("div");
      titleDiv.className = "challenge-title";
      titleDiv.textContent = ch.title;

      const descDiv = document.createElement("div");
      descDiv.className = "challenge-desc";
      descDiv.textContent = ch.desc;

      const infoDiv = document.createElement("div");
      infoDiv.style.marginLeft = "2.7rem";
      infoDiv.appendChild(titleDiv);
      infoDiv.appendChild(descDiv);

      label.appendChild(infoDiv);
      container.appendChild(label);

      // Rainbow special (checkboxes for colours)
      if (ch.rainbow) {
        const colorContainer = document.createElement("div");
        colorContainer.className = "rainbow";
        colorContainer.style.marginLeft = "3rem";
        rainbowColors.forEach(color => {
          const colLabel = document.createElement("label");
          colLabel.style.width = "48%";
          colLabel.style.display = "inline-block";

          const colCheckbox = document.createElement("input");
          colCheckbox.type = "checkbox";
          colCheckbox.id = `rainbow-${color}`;
          colCheckbox.disabled = true; // Disabled until start
          colLabel.appendChild(colCheckbox);

          const emojiSpan = document.createElement("span");
          emojiSpan.textContent = ` ${rainbowEmojis[color]} ${color}`;
          colLabel.appendChild(emojiSpan);

          colorContainer.appendChild(colLabel);
        });
        const bonusDiv = document.createElement("div");
        bonusDiv.className = "bonus";
        bonusDiv.textContent = "‚≠ê Bonus: Each additional colour beyond two.";
        bonusDiv.style.marginTop = "0.3rem";
        colorContainer.appendChild(bonusDiv);

        container.appendChild(colorContainer);
      }

      // Bonus checkbox if any
      if (ch.bonus) {
        const bonusDiv = document.createElement("div");
        bonusDiv.className = "bonus";
        bonusDiv.style.marginLeft = "2.7rem";

        const bonusCheckbox = document.createElement("input");
        bonusCheckbox.type = "checkbox";
        bonusCheckbox.id = `chk${ch.id}b`;
        bonusCheckbox.disabled = !ch.bonusAlwaysEnabled; // Only enabled if always enabled
        bonusDiv.appendChild(bonusCheckbox);

        const bonusText = document.createTextNode(` ‚≠ê Bonus: ${ch.bonus}`);
        bonusDiv.appendChild(bonusText);

        container.appendChild(bonusDiv);
      }
    });
  }

  function updateScore() {
    let main = 0;
    let bonus = 0;
    let rainbowCount = 0;

    // Count rainbow colours checked
    rainbowColors.forEach(color => {
      const cb = document.getElementById(`rainbow-${color}`);
      if (cb && cb.checked) rainbowCount++;
    });

    const rainbowMain = document.getElementById("chk1");
    if (rainbowCount >= 2) {
      if (!rainbowMain.checked) rainbowMain.checked = true;
      if (rainbowCount > 2) bonus += rainbowCount - 2;
    } else {
      if (rainbowMain.checked) rainbowMain.checked = false;
    }

    challenges.forEach(ch => {
      const mainChk = document.getElementById(`chk${ch.id}`);
      const bonusChk = document.getElementById(`chk${ch.id}b`);

      if (mainChk && mainChk.checked && ch.id !== 1) main++;
      if (ch.id === 1 && mainChk && mainChk.checked) main++;

      if (bonusChk && bonusChk.checked && !bonusChk.disabled) bonus++;
    });

    document.getElementById("main-count").textContent = `‚úîÔ∏è Challenges Completed: ${main} / 10`;
    document.getElementById("bonus-count").textContent = `‚≠ê Bonus Points Earned: ${bonus} / 10`;
    document.getElementById("total-score").textContent = `üèÜ Total Score: ${main + bonus} / 20`;
  }

  function sendToSheet(player, challengeID, completed) {
    fetch(endpoint, {
      method: "POST",
      body: JSON.stringify({ player, challengeID, completed }),
      headers: { "Content-Type": "application/json" }
    }).catch(e => console.error("Error sending to sheet:", e));
  }

  function fetchLeaderboard() {
    fetch(endpoint)
      .then(response => response.json())
      .then(data => {
        const players = {};
        data.slice(1).forEach(row => {
          const [player, challengeID, completed] = row;
          if (!players[player]) players[player] = { score: 0, bonus: 0 };
          if (completed === true || completed === "true") {
            if (String(challengeID).endsWith("b")) {
              players[player].bonus++;
            } else {
              players[player].score++;
            }
          }
        });

        const list = document.getElementById("leaderboard-list");
        list.innerHTML = "";
        Object.entries(players)
          .sort((a, b) => (b[1].score + b[1].bonus) - (a[1].score + a[1].bonus))
          .forEach(([name, { score, bonus }]) => {
            const item = document.createElement("li");
            item.textContent = `${name}: ${score} main + ${bonus} bonus = ${score + bonus} pts`;
            list.appendChild(item);
          });
      })
      .catch(e => console.error("Error fetching leaderboard:", e));
  }

  document.addEventListener("DOMContentLoaded", () => {
    const playerInput = document.getElementById("playerName");
    const startButton = document.getElementById("startButton");
    const challengeContainer = document.getElementById("challenge-container");
    const scoreContainer = document.getElementById("score-container");
    const leaderboard = document.getElementById("leaderboard");
    const nameWarning = document.getElementById("nameWarning");
    const refreshLeaderboardBtn = document.getElementById("refreshLeaderboard");

    function toggleStartButton() {
      const hasName = playerInput.value.trim() !== "";
      startButton.disabled = !hasName;
      nameWarning.style.display = hasName ? "none" : "block";
    }

    playerInput.addEventListener("input", toggleStartButton);
    toggleStartButton();

    startButton.addEventListener("click", () => {
      playerName = playerInput.value.trim();
      if (!playerName) {
        alert("Please enter your name before starting.");
        return;
      }
      // Hide input and start button
      playerInput.style.display = "none";
      startButton.style.display = "none";
      nameWarning.style.display = "none";

      // Show challenge container, scores and leaderboard
      challengeContainer.style.display = "block";
      scoreContainer.style.display = "block";
      leaderboard.style.display = "block";

      // Enable checkboxes
      document.querySelectorAll("#challenge-container input[type=checkbox]").forEach(cb => {
        cb.disabled = false;
        cb.checked = false;
      });
      // Also enable rainbow colors checkboxes
      rainbowColors.forEach(color => {
        const cb = document.getElementById(`rainbow-${color}`);
        if(cb) cb.disabled = false;
        if(cb) cb.checked = false;
      });

      updateScore();
    });

    createChallenges();

    // Handle checkbox changes
    document.body.addEventListener("change", e => {
      if (!playerName) return;

      const target = e.target;
      if (target.tagName !== "INPUT" || target.type !== "checkbox") return;

      // For rainbow colors: auto check/uncheck main rainbow checkbox
      if (target.id.startsWith("rainbow-")) {
        const checkedColors = rainbowColors.filter(color => {
          const cb = document.getElementById(`rainbow-${color}`);
          return cb && cb.checked;
        });
        const rainbowMain = document.getElementById("chk1");
        if (checkedColors.length >= 2) {
          if (!rainbowMain.checked) rainbowMain.checked = true;
        } else {
          if (rainbowMain.checked) rainbowMain.checked = false;
        }
        updateScore();
        sendToSheet(playerName, target.id, target.checked);
        return;
      }

      // For other checkboxes:
      // If parent challenge is unchecked, disable & uncheck bonus
      if (target.id.length === 5 && target.id.startsWith("chk")) {
        // This is a parent challenge checkbox
        const bonusCheckbox = document.getElementById(target.id + "b");
        if (bonusCheckbox) {
          if (!target.checked) {
            bonusCheckbox.checked = false;
            bonusCheckbox.disabled = false; // bonuses always enabled, except for those that should lock ‚Äî we are allowing bonus independent now
          } else {
            bonusCheckbox.disabled = false;
          }
        }
      }

      updateScore();

      sendToSheet(playerName, target.id, target.checked);
    });

    // Initial leaderboard fetch
    fetchLeaderboard();

    refreshLeaderboardBtn.addEventListener("click", fetchLeaderboard);

    // Auto refresh leaderboard every 10 seconds
    setInterval(fetchLeaderboard, 10000);
  });
</script>

</body>
</html>
